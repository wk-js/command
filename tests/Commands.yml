# Override wk config
config:
  nocolor: !Not [ !Or [
    !Empty [ !Ref NODE_ENV ],
    !Equals [ !Ref NODE_ENV, development ],
  ] ]
  debug: true

# Shared variables
variables:
  webext_target: !If
    - !Regex [ !Ref command, /tool.?/ ]
    - tool
    - experience
  build_env: !If
    - !Empty [ !Ref NODE_ENV ]
    - development
    - release

# List of commands
commands:
  start:
    default: ${commands.xt.run.chrome}
    firefox: ${commands.xt.run.firefox}
  tool:
    default: ${commands.xt.run.chrome}
    firefox: ${commands.xt.run.firefox}
  packer: cd tools/packer && npm start
  config: npx tsc -p config/tsconfig.json
  task:
    _default: node tmp/tasks.js
    locale: >-
      ${commands.task} locale
      && ${commands.task} preset
    publish: ${commands.task} publish
    bump:
      default: ${commands.task} bump
      patch: ${commands.task.bump} patch
    fetch_profiles: ${commands.task} fetch_profiles
  xt:
    lint: npx web-ext lint --source-dir build/${variables.webext_target}
    run:
      _default: >-
        npx web-ext run
        --start-url http://localhost:3000
        --browser-console
        --source-dir build/${variables.webext_target}
      firefox: ${commands.xt.run} -t firefox-desktop
      chrome: ${commands.xt.run} -t chromium
    sign: >-
      npx web-ext sign
      --api-key=$WEB_EXT_API_KEY
      --api-secret=$WEB_EXT_API_SECRET
      --id=$WEB_EXT_ID
      --channel=$WEB_EXT_CHANNEL
      --source-dir build/${variables.webext_target}
    build: >-
      ${commands.build} && npx web-ext build
      --source-dir build/${variables.webext_target}
  build:
    default: >-
      ${commands.config}
      && npx webpack
      --config tmp/build.js
      --env.target=${variables.build_env}
      --env.environment=${variables.build_env}
    zip: rm -rf build/${variables.webext_target} && ${commands.build} --env.zip